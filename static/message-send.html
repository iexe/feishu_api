<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯å‘é€ - é£ä¹¦APIç®¡ç†å¹³å°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <h1>ğŸ’¬ æ¶ˆæ¯å‘é€</h1>
        <div class="nav-buttons">
            <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
            <a href="/user-search" class="nav-button">ğŸ‘¥ ç”¨æˆ·æœç´¢</a>
            <a href="/image-test" class="nav-button">ğŸ–¼ï¸ å›¾ç‰‡æµ‹è¯•</a>
            <a href="/file-test" class="nav-button">ğŸ“ æ–‡ä»¶æµ‹è¯•</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="container">
            <h1 class="page-title">ğŸ’¬ æ¶ˆæ¯å‘é€</h1>
            <p class="page-subtitle">å‘é€æ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·æˆ–ç¾¤ç»„</p>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('text')">æ–‡æœ¬æ¶ˆæ¯</div>
                    <div class="tab" onclick="switchTab('image')">å›¾ç‰‡æ¶ˆæ¯</div>
                    <div class="tab" onclick="switchTab('file')">æ–‡ä»¶æ¶ˆæ¯</div>
                </div>
            </div>
            
            <!-- æ–‡æœ¬æ¶ˆæ¯è¡¨å• -->
            <div id="text-tab" class="tab-content active">
                <form id="text-message-form">
                    <div class="form-group">
                        <label for="receive-id-type">æ¥æ”¶è€…IDç±»å‹</label>
                        <select id="receive-id-type" name="receive_id_type" required>
                            <option value="user_id">ç”¨æˆ·ID</option>
                            <option value="open_id">Open ID</option>
                            <option value="union_id">Union ID</option>
                            <option value="chat_id">ç¾¤èŠID</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="receive-id">æ¥æ”¶è€…ID</label>
                        <input type="text" id="receive-id" name="receive_id" placeholder="è¾“å…¥æ¥æ”¶è€…ID" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="message-content">æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="message-content" name="content" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn">ğŸ“¤ å‘é€æ–‡æœ¬æ¶ˆæ¯</button>
                </form>
            </div>
            
            <!-- å›¾ç‰‡æ¶ˆæ¯è¡¨å• -->
            <div id="image-tab" class="tab-content">
                <form id="image-message-form">
                    <div class="form-group">
                        <label for="img-receive-id-type">æ¥æ”¶è€…IDç±»å‹</label>
                        <select id="img-receive-id-type" name="receive_id_type" required>
                            <option value="user_id">ç”¨æˆ·ID</option>
                            <option value="open_id">Open ID</option>
                            <option value="union_id">Union ID</option>
                            <option value="chat_id">ç¾¤èŠID</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="img-receive-id">æ¥æ”¶è€…ID</label>
                        <input type="text" id="img-receive-id" name="receive_id" placeholder="è¾“å…¥æ¥æ”¶è€…ID" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ä¸Šä¼ å›¾ç‰‡</label>
                        <div class="file-upload" id="image-upload">
                            <p>ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½è‡³æ­¤</p>
                            <input type="file" id="image-file" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="form-group" id="image-key-group" style="display: none;">
                        <label for="image-key">å›¾ç‰‡Key</label>
                        <input type="text" id="image-key" name="image_key" placeholder="å›¾ç‰‡ä¸Šä¼ åè‡ªåŠ¨å¡«å……">
                    </div>
                    
                    <button type="submit" class="btn">ğŸ“¤ å‘é€å›¾ç‰‡æ¶ˆæ¯</button>
                </form>
            </div>
            
            <!-- æ–‡ä»¶æ¶ˆæ¯è¡¨å• -->
            <div id="file-tab" class="tab-content">
                <form id="file-message-form">
                    <div class="form-group">
                        <label for="file-receive-id-type">æ¥æ”¶è€…IDç±»å‹</label>
                        <select id="file-receive-id-type" name="receive_id_type" required>
                            <option value="user_id">ç”¨æˆ·ID</option>
                            <option value="open_id">Open ID</option>
                            <option value="union_id">Union ID</option>
                            <option value="chat_id">ç¾¤èŠID</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-receive-id">æ¥æ”¶è€…ID</label>
                        <input type="text" id="file-receive-id" name="receive_id" placeholder="è¾“å…¥æ¥æ”¶è€…ID" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ä¸Šä¼ æ–‡ä»¶</label>
                        <div class="file-upload" id="file-upload">
                            <p>ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½è‡³æ­¤</p>
                            <input type="file" id="file" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="form-group" id="file-key-group" style="display: none;">
                        <label for="file-key">æ–‡ä»¶Key</label>
                        <input type="text" id="file-key" name="file_key" placeholder="æ–‡ä»¶ä¸Šä¼ åè‡ªåŠ¨å¡«å……">
                    </div>
                    
                    <button type="submit" class="btn">ğŸ“¤ å‘é€æ–‡ä»¶æ¶ˆæ¯</button>
                </form>
            </div>
            
            <div id="result-container" class="result-container">
                <div class="result-title">å‘é€ç»“æœ</div>
                <div id="result-content"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>åŸºäºé£ä¹¦å¼€æ”¾å¹³å° SDK v3.4.26 | æŠ€æœ¯æ”¯æŒ</p>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ·»åŠ æ–°çš„æ´»åŠ¨çŠ¶æ€
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('image-upload').addEventListener('click', function() {
            document.getElementById('image-file').click();
        });
        
        document.getElementById('image-file').addEventListener('change', function() {
            uploadImage(this.files[0]);
        });
        
        // æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('file-upload').addEventListener('click', function() {
            document.getElementById('file').click();
        });
        
        document.getElementById('file').addEventListener('change', function() {
            uploadFile(this.files[0]);
        });
        
        // æ‹–æ‹½ä¸Šä¼ 
        setupDragAndDrop('image-upload', 'image-file', uploadImage);
        setupDragAndDrop('file-upload', 'file', uploadFile);
        
        function setupDragAndDrop(dropZoneId, fileInputId, uploadFunction) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropZone.classList.add('highlight');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('highlight');
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    uploadFunction(files[0]);
                }
            }
        }
        
        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage(file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/files/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('image-key').value = result.data.image_key;
                    document.getElementById('image-key-group').style.display = 'block';
                    document.getElementById('image-upload').innerHTML = 
                        `<p>å›¾ç‰‡å·²ä¸Šä¼ : ${file.name}</p><p>å›¾ç‰‡Key: ${result.data.image_key}</p>`;
                } else {
                    showResult(result.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (error) {
                showResult('å›¾ç‰‡ä¸Šä¼ å‡ºé”™: ' + error.message, true);
            }
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('file-key').value = result.data.file_key;
                    document.getElementById('file-key-group').style.display = 'block';
                    document.getElementById('file-upload').innerHTML = 
                        `<p>æ–‡ä»¶å·²ä¸Šä¼ : ${file.name}</p><p>æ–‡ä»¶Key: ${result.data.file_key}</p>`;
                } else {
                    showResult(result.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (error) {
                showResult('æ–‡ä»¶ä¸Šä¼ å‡ºé”™: ' + error.message, true);
            }
        }
        
        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        document.getElementById('text-message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                receive_id_type: formData.get('receive_id_type'),
                receive_id: formData.get('receive_id'),
                content: formData.get('content')
            };
            
            try {
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('æ–‡æœ¬æ¶ˆæ¯å‘é€æˆåŠŸ', false);
                    this.reset();
                } else {
                    showResult(result.error || 'æ¶ˆæ¯å‘é€å¤±è´¥', true);
                }
            } catch (error) {
                showResult('å‘é€å‡ºé”™: ' + error.message, true);
            }
        });
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯
        document.getElementById('image-message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                receive_id_type: formData.get('receive_id_type'),
                receive_id: formData.get('receive_id'),
                image_key: formData.get('image_key')
            };
            
            try {
                const response = await fetch('/api/messages/send-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ', false);
                } else {
                    showResult(result.error || 'æ¶ˆæ¯å‘é€å¤±è´¥', true);
                }
            } catch (error) {
                showResult('å‘é€å‡ºé”™: ' + error.message, true);
            }
        });
        
        // å‘é€æ–‡ä»¶æ¶ˆæ¯
        document.getElementById('file-message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                receive_id_type: formData.get('receive_id_type'),
                receive_id: formData.get('receive_id'),
                file_key: formData.get('file_key')
            };
            
            try {
                const response = await fetch('/api/messages/send-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('æ–‡ä»¶æ¶ˆæ¯å‘é€æˆåŠŸ', false);
                } else {
                    showResult(result.error || 'æ¶ˆæ¯å‘é€å¤±è´¥', true);
                }
            } catch (error) {
                showResult('å‘é€å‡ºé”™: ' + error.message, true);
            }
        });
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, isError = false) {
            const container = document.getElementById('result-container');
            const content = document.getElementById('result-content');
            
            container.style.display = 'block';
            container.className = 'result-container' + (isError ? ' error' : '');
            content.textContent = message;
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (!isError) {
                setTimeout(() => {
                    container.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>