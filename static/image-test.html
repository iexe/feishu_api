<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æµ‹è¯• - é£ä¹¦APIç®¡ç†å¹³å°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <h1>ğŸ–¼ï¸ å›¾ç‰‡æµ‹è¯•</h1>
        <div class="nav-buttons">
            <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
            <a href="/user-search" class="nav-button">ğŸ‘¥ ç”¨æˆ·æœç´¢</a>
            <a href="/message-send" class="nav-button">ğŸ’¬ æ¶ˆæ¯å‘é€</a>
            <a href="/file-test" class="nav-button">ğŸ“ æ–‡ä»¶æµ‹è¯•</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="container">
            <h1 class="page-title">ğŸ–¼ï¸ å›¾ç‰‡ä¸Šä¼ ä¸æµ‹è¯•</h1>
            <p class="page-subtitle">ä¸Šä¼ å›¾ç‰‡å¹¶æµ‹è¯•å›¾ç‰‡æ¶ˆæ¯å‘é€åŠŸèƒ½</p>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('upload')">ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="tab" onclick="switchTab('test')">æµ‹è¯•å‘é€</div>
                </div>
            </div>
            
            <!-- ä¸Šä¼ å›¾ç‰‡æ ‡ç­¾é¡µ -->
            <div id="upload-tab" class="tab-content active">
                <div class="form-group">
                    <label for="image-file">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
                    <input type="file" id="image-file" accept="image/*">
                </div>
                
                <button type="button" class="btn" onclick="uploadImage()">ğŸ“¤ ä¸Šä¼ å›¾ç‰‡</button>
                
                <div class="result-container" id="upload-result-container">
                    <div class="result-title">ä¸Šä¼ ç»“æœ</div>
                    <div id="upload-result-content"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•å‘é€æ ‡ç­¾é¡µ -->
            <div id="test-tab" class="tab-content">
                <div class="form-group">
                    <label for="image-key">Image Key</label>
                    <input type="text" id="image-key" placeholder="ä»ä¸Šä¼ é¡µé¢è·å–æˆ–æ‰‹åŠ¨è¾“å…¥">
                </div>
                
                <div class="form-group">
                    <label for="receive-id-type">æ¥æ”¶è€…IDç±»å‹</label>
                    <select id="receive-id-type">
                        <option value="user_id">ç”¨æˆ·ID</option>
                        <option value="open_id">Open ID</option>
                        <option value="union_id">Union ID</option>
                        <option value="chat_id">ç¾¤èŠID</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="receive-id">æ¥æ”¶è€…ID</label>
                    <input type="text" id="receive-id" placeholder="è¾“å…¥æ¥æ”¶è€…ID">
                </div>
                
                <button type="button" class="btn" onclick="sendImageMessage()">ğŸ“¤ å‘é€å›¾ç‰‡æ¶ˆæ¯</button>
                
                <div class="result-container" id="send-result-container">
                    <div class="result-title">å‘é€ç»“æœ</div>
                    <div id="send-result-content"></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>åŸºäºé£ä¹¦å¼€æ”¾å¹³å° SDK v3.4.26 | æŠ€æœ¯æ”¯æŒ</p>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ·»åŠ æ–°çš„æ´»åŠ¨çŠ¶æ€
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
        
        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage() {
            const fileInput = document.getElementById('image-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadResult('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶', true);
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/files/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('image-key').value = result.data.image_key;
                    showUploadResult(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼<br>Image Key: ${result.data.image_key}<br>MD5: ${result.data.md5}`, false);
                    
                    // æç¤ºç”¨æˆ·åˆ‡æ¢åˆ°æµ‹è¯•å‘é€æ ‡ç­¾é¡µ
                    setTimeout(() => {
                        switchTab('test');
                        showSendResult('ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„Image Keyå‘é€å›¾ç‰‡æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·', false, true);
                    }, 1000);
                } else {
                    showUploadResult('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + result.error, true);
                }
            } catch (error) {
                showUploadResult('å›¾ç‰‡ä¸Šä¼ å‡ºé”™: ' + error.message, true);
            }
        }
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯
        async function sendImageMessage() {
            const imageKey = document.getElementById('image-key').value;
            const receiveIdType = document.getElementById('receive-id-type').value;
            const receiveId = document.getElementById('receive-id').value;
            
            if (!imageKey) {
                showSendResult('è¯·è¾“å…¥Image Key', true);
                return;
            }
            
            if (!receiveId) {
                showSendResult('è¯·è¾“å…¥æ¥æ”¶è€…ID', true);
                return;
            }
            
            try {
                const response = await fetch('/api/messages/send-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receive_id_type: receiveIdType,
                        receive_id: receiveId,
                        image_key: imageKey
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSendResult(`å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸï¼<br>æ¶ˆæ¯ID: ${result.data.message_id}`, false);
                } else {
                    showSendResult('å›¾ç‰‡æ¶ˆæ¯å‘é€å¤±è´¥: ' + result.error, true);
                }
            } catch (error) {
                showSendResult('å›¾ç‰‡æ¶ˆæ¯å‘é€å‡ºé”™: ' + error.message, true);
            }
        }
        
        // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
        function showUploadResult(message, isError = false) {
            const container = document.getElementById('upload-result-container');
            const content = document.getElementById('upload-result-content');
            
            container.style.display = 'block';
            container.className = 'result-container' + (isError ? ' error' : '');
            content.innerHTML = message;
        }
        
        // æ˜¾ç¤ºå‘é€ç»“æœ
        function showSendResult(message, isError = false, isInfo = false) {
            const container = document.getElementById('send-result-container');
            const content = document.getElementById('send-result-content');
            
            container.style.display = 'block';
            if (isError) {
                container.className = 'result-container error';
            } else if (isInfo) {
                container.className = 'result-container info';
            } else {
                container.className = 'result-container';
            }
            content.innerHTML = message;
        }
    </script>
</body>
</html>