<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <h1>ğŸ“ æ–‡ä»¶æµ‹è¯•</h1>
        <div class="nav-buttons">
            <a href="/" class="nav-button">ğŸ  é¦–é¡µ</a>
            <a href="/user-search" class="nav-button">ğŸ‘¥ ç”¨æˆ·æœç´¢</a>
            <a href="/message-send" class="nav-button">ğŸ’¬ æ¶ˆæ¯å‘é€</a>
            <a href="/image-test" class="nav-button">ğŸ–¼ï¸ å›¾ç‰‡æµ‹è¯•</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="container">
            <h1 class="page-title">ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
            <p class="page-subtitle">ä¸Šä¼ æ–‡ä»¶å¹¶æµ‹è¯•æ–‡ä»¶æ¶ˆæ¯å‘é€åŠŸèƒ½</p>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('upload')">ä¸Šä¼ æ–‡ä»¶</div>
                    <div class="tab" onclick="switchTab('types')">æ–‡ä»¶ç±»å‹</div>
                    <div class="tab" onclick="switchTab('test')">æµ‹è¯•å‘é€</div>
                    <div class="tab" onclick="switchTab('list')">æ–‡ä»¶åˆ—è¡¨</div>
                </div>
            </div>
        
        <!-- ä¸Šä¼ æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="upload-tab" class="tab-content active">
            <div class="section">
                <h2>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
                <div class="form-group">
                    <label for="fileInput">é€‰æ‹©æ–‡ä»¶:</label>
                    <input type="file" id="fileInput">
                </div>
                <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
                <div id="uploadResult" class="result" style="display:none;"></div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶ç±»å‹æ ‡ç­¾é¡µ -->
        <div id="types-tab" class="tab-content">
            <div class="section">
                <h2>é£ä¹¦æ”¯æŒçš„æ–‡ä»¶ç±»å‹</h2>
                <div class="file-type-description">
                    <p><strong>opusï¼š</strong> OPUS éŸ³é¢‘æ–‡ä»¶ã€‚å…¶ä»–æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶ï¼Œè¯·è½¬ä¸º OPUS æ ¼å¼åä¸Šä¼ ã€‚</p>
                    <p><strong>mp4ï¼š</strong> MP4 æ ¼å¼è§†é¢‘æ–‡ä»¶</p>
                    <p><strong>pdfï¼š</strong> PDF æ ¼å¼æ–‡ä»¶</p>
                    <p><strong>docï¼š</strong> DOC æ ¼å¼æ–‡ä»¶</p>
                    <p><strong>xlsï¼š</strong> XLS æ ¼å¼æ–‡ä»¶</p>
                    <p><strong>pptï¼š</strong> PPT æ ¼å¼æ–‡ä»¶</p>
                    <p><strong>streamï¼š</strong> stream æ ¼å¼æ–‡ä»¶ã€‚è‹¥ä¸Šä¼ æ–‡ä»¶ä¸å±äºä»¥ä¸Šæšä¸¾ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ stream æ ¼å¼</p>
                    
                    <div style="background-color: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p><strong>éŸ³é¢‘è½¬æ¢æç¤ºï¼š</strong> å¯ä½¿ç”¨ ffmpeg è½¬æ¢æ ¼å¼ï¼šffmpeg -i SourceFile.mp3 -acodec libopus -ac 1 -ar 16000 TargetFile.opus</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•å‘é€æ ‡ç­¾é¡µ -->
        <div id="test-tab" class="tab-content">
            <div class="section">
                <h2>å‘é€æ–‡ä»¶æ¶ˆæ¯æµ‹è¯•</h2>
                <div class="form-group">
                    <label for="fileKey">File Key:</label>
                    <input type="text" id="fileKey" placeholder="ä¸Šä¼ æ–‡ä»¶åè‡ªåŠ¨å¡«å……æˆ–æ‰‹åŠ¨è¾“å…¥">
                </div>
                <div class="form-group">
                    <label for="receiveIdType">æ¥æ”¶è€…IDç±»å‹:</label>
                    <select id="receiveIdType">
                        <option value="user_id">ç”¨æˆ·ID</option>
                        <option value="open_id">Open ID</option>
                        <option value="union_id">Union ID</option>
                        <option value="chat_id">ç¾¤èŠID</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="receiveId">æ¥æ”¶è€…ID:</label>
                    <input type="text" id="receiveId" placeholder="è¾“å…¥æ¥æ”¶è€…ID">
                </div>
                <button onclick="sendFileMessage()">å‘é€æ–‡ä»¶æ¶ˆæ¯</button>
                <div id="sendResult" class="result" style="display:none;"></div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨æ ‡ç­¾é¡µ -->
        <div id="list-tab" class="tab-content">
            <div class="section">
                <h2>å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨</h2>
                <button onclick="viewFileList()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                <div id="listResult" class="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ·»åŠ æ–°çš„æ´»åŠ¨çŠ¶æ€
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('uploadResult', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileInfo = `
æ–‡ä»¶å: ${file.name}
æ–‡ä»¶å¤§å°: ${file.size} bytes (${(file.size / 1024).toFixed(2)} KB)
æ–‡ä»¶ç±»å‹: ${file.type || 'æœªçŸ¥'}
æœ€åä¿®æ”¹æ—¶é—´: ${new Date(file.lastModified).toLocaleString()}
            `;
            showResult('uploadResult', fileInfo, 'info');
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const successInfo = `
ä¸Šä¼ æˆåŠŸ!
File Key: ${result.data.file_key}
MD5: ${result.data.md5}
SHA256: ${result.data.sha256}
                    `;
                    showResult('uploadResult', successInfo, 'success');
                    
                    // å¡«å……file_keyåˆ°å‘é€è¡¨å•
                    document.getElementById('fileKey').value = result.data.file_key;
                } else {
                    showResult('uploadResult', `ä¸Šä¼ å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('uploadResult', `ä¸Šä¼ å‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        // å‘é€æ–‡ä»¶æ¶ˆæ¯
        async function sendFileMessage() {
            const fileKey = document.getElementById('fileKey').value;
            const receiveIdType = document.getElementById('receiveIdType').value;
            const receiveId = document.getElementById('receiveId').value;
            
            if (!fileKey) {
                showResult('sendResult', 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶è·å–File Key', 'error');
                return;
            }
            
            if (!receiveId) {
                showResult('sendResult', 'è¯·è¾“å…¥æ¥æ”¶è€…ID', 'error');
                return;
            }
            
            // æ˜¾ç¤ºå‘é€ä¿¡æ¯
            const sendInfo = `
å‘é€æ–‡ä»¶æ¶ˆæ¯:
æ¥æ”¶è€…ç±»å‹: ${receiveIdType}
æ¥æ”¶è€…ID: ${receiveId}
æ–‡ä»¶Key: ${fileKey}
            `;
            showResult('sendResult', sendInfo, 'info');
            
            try {
                const response = await fetch('/api/messages/send-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receive_id_type: receiveIdType,
                        receive_id: receiveId,
                        file_key: fileKey
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const successInfo = `
æ¶ˆæ¯å‘é€æˆåŠŸ!
æ¶ˆæ¯ID: ${result.data.message_id}
                    `;
                    showResult('sendResult', successInfo, 'success');
                } else {
                    showResult('sendResult', `å‘é€å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('sendResult', `å‘é€å‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        // æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
        async function viewFileList() {
            try {
                const response = await fetch('/api/files/list?limit=20');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    let files = "å·²ä¸Šä¼ çš„æ–‡ä»¶:\n\n";
                    result.data.forEach((record, index) => {
                        files += `${index + 1}. ${record.original_name}\n`;
                        files += `   ç±»å‹: ${record.resource_type}\n`;
                        files += `   å¤§å°: ${(record.file_size / 1024).toFixed(2)} KB\n`;
                        files += `   Key: ${record.resource_key}\n`;
                        files += `   ä¸Šä¼ æ—¶é—´: ${record.upload_time}\n\n`;
                    });
                    showResult('listResult', files, 'info');
                } else {
                    showResult('listResult', `è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('listResult', `è·å–æ–‡ä»¶åˆ—è¡¨å‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = `result ${type}`;
        }
    </script>
</body>
</html>